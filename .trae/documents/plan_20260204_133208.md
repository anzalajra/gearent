Saya telah menganalisis kode sumber (Laravel Filament) dan menemukan akar masalah dari double booking dan logika kalender yang Anda laporkan. Sistem saat ini lebih mengandalkan **Validasi Tanggal** daripada **Status Fisik Unit**.

Berikut adalah rencana perbaikan komprehensif:

# Rencana Perbaikan Sistem Rental

## 1. Perbaikan Picking Operation (Prioritas Utama)
Masalah utama adalah sistem mengizinkan pickup meskipun unit fisiknya masih status "Rented" (karena sewa sebelumnya telat kembali).

### A. Deteksi Status Real-time
**Lokasi:** `app/Filament/Resources/Rentals/Pages/Rentals/PickupOperation.php`
*   **Perubahan:** Memodifikasi tabel barang untuk mengecek status fisik `ProductUnit` saat ini.
*   **Fitur Baru:** Menambahkan indikator status di kolom Serial Number.
    *   Jika status unit `available` atau `scheduled` (aman) -> Tampil normal.
    *   Jika status unit `rented` (masih dibawa orang lain) -> Tampil Badge Merah **"UNAVAILABLE"**.

### B. Fitur "Swap Unit" (Ganti Unit)
**Lokasi:** `PickupOperation.php`
*   **Masalah:** Order dari frontend mengunci unit spesifik. Admin butuh cara cepat untuk mengganti unit ke yang tersedia tanpa membatalkan order.
*   **Solusi:** Menambahkan tombol **"Tukar Unit" (Swap)** di setiap baris barang.
    *   Tombol ini akan membuka modal yang menampilkan daftar unit lain (dari produk yang sama) yang **benar-benar tersedia** saat ini.
    *   Admin bisa memilih unit pengganti, dan sistem akan mengupdate `rental_item` ke unit baru tersebut.

### C. Hard Validation (Pencegahan Sistem)
**Lokasi:** `app/Models/Rental.php` (Method `validatePickup`)
*   **Perubahan:** Menambahkan pengecekan akhir sebelum status berubah jadi Active.
*   **Logic:** `Jika ada unit yang status fisiknya masih 'rented', tolak validasi dan beri pesan error.`

## 2. Perbaikan Logika Kalender Frontend
**Lokasi:** `app/Models/Product.php` (Method `getBookedDates`)
*   **Analisis:** Kode saat ini seharusnya sudah mengecualikan status `completed`. Namun, ada kemungkinan logika rentang tanggal (Start/End) terlalu agresif atau ada data sampah.
*   **Perbaikan:**
    *   Saya akan meninjau ulang query `whereIn` status untuk memastikan `completed` benar-benar terabaikan.
    *   Memastikan jam `end_date` rental yang sudah selesai tidak "memakan" slot hari berikutnya.

## 3. Peningkatan Notifikasi & UI
*   **Picking Operation:** Menambahkan *Banner Warning* di atas halaman jika terdeteksi ada unit yang bentrok/unavailable.
*   **Rental Form:** Memastikan dropdown pemilihan unit memfilter unit yang sedang "Late Return".

---
**Langkah Implementasi:**
1.  Modifikasi `PickupOperation.php` untuk menampilkan status real-time & tombol Swap.
2.  Implementasi logic "Swap Unit" (update `rental_items` & `delivery_items`).
3.  Tambahkan validasi keras di `Rental.php`.
4.  Verifikasi ulang logika `getBookedDates` di `Product.php`.

Apakah Anda setuju dengan rencana perbaikan ini?
